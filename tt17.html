<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cháº¥m Ä‘iá»ƒm theo TT17</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles/common.css">
  <link rel="stylesheet" href="styles/list-pages.css">
  <style>
#formHistoryModal .modal-content, #formHistoryModal > div {
  max-width: 95vw !important;
  min-width: 900px !important;
  padding: 32px 20px 24px 20px !important;
  overflow-x: auto;
  max-height: 80vh !important;
  overflow-y: auto !important;
}
#formHistoryModal table { min-width: 1200px; }
#formHistoryModal table { border-collapse: collapse; width: 100%; font-size: 14px; background: #fff; }
#formHistoryModal th, #formHistoryModal td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
#formHistoryModal th { background: #f5f5f5; position: sticky; top: 0; z-index: 2; }
#formHistoryModal tr:hover { background: #e3f2fd; }
#formHistoryModal input[type="text"] { width: 95%; padding: 2px 4px; font-size: 13px; border: 1px solid #bbb; border-radius: 3px; }
#formHistoryModal .filter-row input { background: #f9f9f9; }
@media (max-width: 900px) { #formHistoryModal table, #formHistoryModal th, #formHistoryModal td { font-size: 12px; } }

/* NÃºt thao tÃ¡c trong báº£ng */
.action-btn {
  min-width: 110px;
  padding: 6px 0;
  font-size: 14px;
  border-radius: 5px;
  border: none;
  margin: 2px 4px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.action-view {
  background: #e3f2fd;
  color: #1976d2;
  border: 1px solid #90caf9;
}
.action-view:hover {
  background: #bbdefb;
}
.action-delete {
  background: #ffebee;
  color: #d32f2f;
  border: 1px solid #ffcdd2;
}
.action-delete:hover {
  background: #ffcdd2;
}
/* NÃºt trong modal footer */
#formHistoryModal .modal-footer-btn {
  min-width: 100px;
  padding: 8px 0;
  font-size: 15px;
  border-radius: 5px;
  border: none;
  margin-left: 8px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
#formHistoryModal .btn-close {
  background: #f5f5f5;
  color: #333;
  border: 1px solid #bbb;
}
#formHistoryModal .btn-close:hover {
  background: #e0e0e0;
}
#formHistoryModal .btn-create {
  background: #1976d2;
  color: #fff;
  border: 1px solid #1976d2;
}
#formHistoryModal .btn-create:hover {
  background: #1565c0;
}
</style>
</head>
<body>
  <header class="main-header" style="text-align: center;">
    <h1>Há»‡ thá»‘ng cháº¥m Ä‘iá»ƒm HSNV</h1>
  </header>

  <div class="container">
    <div class="description">
      <p>Chá»n loáº¡i biá»ƒu máº«u cháº¥m Ä‘iá»ƒm phÃ¹ há»£p vá»›i yÃªu cáº§u cá»§a báº¡n</p>
    </div>

    <div class="forms-grid">
      <div class="form-card" onclick="openFormsList('SN')">
        <div class="form-icon">ğŸ”</div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm SÆ°u tra</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng sÆ°u tra, Ä‘iá»u tra thÃ´ng tin
        </div>
        <button class="form-btn">Xem danh sÃ¡ch</button>
      </div>

      <div class="form-card" onclick="openFormHistoryDialog('phieu-cham-diem-dtcb','forms/phieu-cham-diem-dtcb.html')">
        <div class="form-icon">ğŸ“‹</div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm Äiá»u tra cÆ¡ báº£n</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng Ä‘iá»u tra cÆ¡ báº£n
        </div>
        <button class="form-btn">Má»Ÿ biá»ƒu máº«u</button>
      </div>

      <div class="form-card" onclick="openFormHistoryDialog('phieu-cham-diem-hn','forms/phieu-cham-diem-hn.html')">
        <div class="form-icon">âš ï¸</div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm Hiá»m nghi</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng Ä‘iá»u tra hiá»m nghi
        </div>
        <button class="form-btn">Má»Ÿ biá»ƒu máº«u</button>
      </div>

      <div class="form-card" onclick="openFormHistoryDialog('phieu-cham-diem-chuyen-an','forms/phieu-cham-diem-chuyen-an.html')">
        <div class="form-icon">ğŸ¯</div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm ChuyÃªn Ã¡n</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng chuyÃªn Ã¡n
        </div>
        <button class="form-btn">Má»Ÿ biá»ƒu máº«u</button>
      </div>

      <div class="form-card" onclick="openFormHistoryDialog('phieu-cham-diem-lc','forms/phieu-cham-diem-lc.html')">
        <div class="form-icon">ğŸ¤</div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm Cá»™ng tÃ¡c viÃªn bÃ­ máº­t</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng cá»™ng tÃ¡c viÃªn bÃ­ máº­t
        </div>
        <button class="form-btn">Má»Ÿ biá»ƒu máº«u</button>
      </div>

      <div class="form-card" onclick="openFormHistoryDialog('phieu-cham-diem-lh','forms/phieu-cham-diem-lh.html')">
        <div class="form-icon">ğŸ“®</div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm Há»™p thÆ° bÃ­ máº­t</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng há»™p thÆ° bÃ­ máº­t
        </div>
        <button class="form-btn">Má»Ÿ biá»ƒu máº«u</button>
      </div>

      <div class="form-card" onclick="openFormHistoryDialog('phieu-cham-diem-la','forms/phieu-cham-diem-la.html')">
        <div class="form-icon">ğŸ­</div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm Vai áº£o nghiá»‡p vá»¥</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng vai áº£o nghiá»‡p vá»¥
        </div>
        <button class="form-btn">Má»Ÿ biá»ƒu máº«u</button>
      </div>

      <div class="form-card" onclick="openFormHistoryDialog('phieu-cham-diem-ln','forms/phieu-cham-diem-ln.html')">
        <div class="form-icon">ğŸ </div>
        <div class="form-title">Cháº¥m Ä‘iá»ƒm NhÃ  nghiá»‡p vá»¥</div>
        <div class="form-description">
          Biá»ƒu máº«u cháº¥m Ä‘iá»ƒm hoáº¡t Ä‘á»™ng nhÃ  nghiá»‡p vá»¥
        </div>
        <button class="form-btn">Má»Ÿ biá»ƒu máº«u</button>
      </div>
    </div>

    <footer class="main-footer">
      <p>&copy; 2024 Há»‡ thá»‘ng cháº¥m Ä‘iá»ƒm HSNV. PhÃ¡t triá»ƒn bá»Ÿi Ä‘á»™i ngÅ© chuyÃªn mÃ´n.</p>
    </footer>
  </div>

  <!-- Modal hiá»ƒn thá»‹ danh sÃ¡ch form Ä‘Ã£ Ä‘iá»n -->
  <div id="formHistoryModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3);">
    <div style="background:#fff; margin:60px auto; padding:24px; border-radius:8px; max-width:600px; min-width:320px; position:relative;">
      <h2>Danh sÃ¡ch cÃ¡c form Ä‘Ã£ Ä‘iá»n</h2>
      <div id="formHistoryList">Äang táº£i...</div>
      <div style="margin-top:16px; text-align:right;">
        <button class="modal-footer-btn btn-close" onclick="closeFormHistoryModal()">ÄÃ³ng</button>
        <button class="modal-footer-btn btn-create" onclick="createNewForm()">Táº¡o má»›i</button>
      </div>
    </div>
  </div>

  <script>
    // Check if user is logged in
    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem('isLoggedIn');
      if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
      }
    }

    function openForm(formPath) {
      // Open form in new tab
      window.open(formPath, '_blank');
    }

    function openFormsList(formType) {
      // Open forms list page
      window.open('forms-list.html', '_blank');
    }

    let currentFormType = null;
    function openFormHistoryDialog(formType, formPath) {
      currentFormType = formType;
      document.getElementById('formHistoryModal').style.display = 'block';
      document.getElementById('formHistoryList').innerHTML = 'Äang táº£i...';
      fetch(`/api/forms/list?form_type=${encodeURIComponent(formType)}`)
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            document.getElementById('formHistoryList').innerHTML = '<i>ChÆ°a cÃ³ báº£n ghi nÃ o.</i>';
            return;
          }
          renderFormHistoryTable(data, formPath);
        })
        .catch(()=>{
          document.getElementById('formHistoryList').innerHTML = '<span style="color:red">Lá»—i táº£i dá»¯ liá»‡u!</span>';
        });
    }
    function closeFormHistoryModal() {
      document.getElementById('formHistoryModal').style.display = 'none';
      localStorage.removeItem('lastViewedFormId');
    }
    function createNewForm() {
      closeFormHistoryModal();
      if (currentFormType === 'phieu-cham-diem-hn') {
        window.open('forms/phieu-cham-diem-hn.html', '_blank');
      } else if (currentFormType === 'phieu-cham-diem-dtcb') {
        window.open('forms/phieu-cham-diem-dtcb.html', '_blank');
      }
    }
    function viewForm(formPath, formId) {
      localStorage.setItem('lastViewedFormId', formId);
      window.open(`${formPath}?form_id=${encodeURIComponent(formId)}`, '_blank');
    }

    let formHistoryRawData = [];
    function renderFormHistoryTable(data, formPath) {
      formHistoryRawData = data.slice();
      // Sáº¯p xáº¿p theo thá»i gian (nÄƒm, thÃ¡ng, ngÃ y) má»›i nháº¥t lÃªn Ä‘áº§u
      data.sort((a, b) => {
        const ia = a.info || {}, ib = b.info || {};
        const getDate = i => `${i.thoi_gian_tu_nam||''}${i.thoi_gian_tu_thang||''}${i.thoi_gian_tu_ngay||''}`;
        return getDate(ib).localeCompare(getDate(ia));
      });
      const lastViewedFormId = localStorage.getItem('lastViewedFormId');
      let html = '<table><thead>';
      html += '<tr><th>Há» tÃªn</th><th>Cáº¥p báº­c</th><th>Chá»©c vá»¥</th><th>ÄÆ¡n vá»‹</th><th>Loáº¡i ÄT</th><th>Sá»‘ há»“ sÆ¡</th><th>Thá»i gian</th><th>Äá»‹a danh CB</th><th>Äá»‹a danh LÄ</th><th>Tá»•ng Ä‘iá»ƒm CB</th><th>Tá»•ng Ä‘iá»ƒm LÄ</th><th>Xáº¿p loáº¡i CB</th><th>Xáº¿p loáº¡i LÄ</th><th>Thao tÃ¡c</th></tr>';
      // HÃ ng filter
      html += '<tr class="filter-row">';
      for (let i = 0; i < 13; i++) {
        html += `<td><input type="text" oninput="filterFormHistoryTable()" data-col="${i}" placeholder="Lá»c..." /></td>`;
      }
      html += '<td></td></tr></thead><tbody id="formHistoryTableBody">';
      data.forEach(item => {
        const i = item.info || {};
        const highlight = item.form_id === lastViewedFormId ? ' style="background:#ffe082;"' : '';
        html += `<tr${highlight}>
          <td>${i.ho_ten||''}</td>
          <td>${i.cap_bac||''}</td>
          <td>${i.chuc_vu||''}</td>
          <td>${i.don_vi||''}</td>
          <td>${i.loai_doi_tuong||''}</td>
          <td>${i.so_ho_so||''}</td>
          <td>${i.thoi_gian_tu_ngay||''}/${i.thoi_gian_tu_thang||''}/${i.thoi_gian_tu_nam||''} - ${i.thoi_gian_den_ngay||''}/${i.thoi_gian_den_thang||''}/${i.thoi_gian_den_nam||''}</td>
          <td>${i.can_bo_dia_danh||''}</td>
          <td>${i.lanh_dao_dia_danh||''}</td>
          <td>${item.tong_diem_cb||''}</td>
          <td>${item.tong_diem_ch||''}</td>
          <td>${item.xep_loai_cb||''}</td>
          <td>${item.xep_loai_ch||''}</td>
          <td>
            <button class="action-btn action-view" onclick="viewForm('${formPath}','${item.form_id}')">Xem/Chá»‰nh sá»­a</button>
            <button class="action-btn action-delete" onclick="deleteForm('${item.form_id}', this)">XÃ³a</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('formHistoryList').innerHTML = html;
    }
    function filterFormHistoryTable() {
      const filters = Array.from(document.querySelectorAll('#formHistoryModal .filter-row input')).map(input => input.value.trim().toLowerCase());
      let filtered = formHistoryRawData.filter(item => {
        const i = item.info || {};
        const row = [
          i.ho_ten||'', i.cap_bac||'', i.chuc_vu||'', i.don_vi||'', i.loai_doi_tuong||'', i.so_ho_so||'',
          `${i.thoi_gian_tu_ngay||''}/${i.thoi_gian_tu_thang||''}/${i.thoi_gian_tu_nam||''} - ${i.thoi_gian_den_ngay||''}/${i.thoi_gian_den_thang||''}/${i.thoi_gian_den_nam||''}`,
          i.can_bo_dia_danh||'', i.lanh_dao_dia_danh||'',
          item.tong_diem_cb||'', item.tong_diem_ch||'', item.xep_loai_cb||'', item.xep_loai_ch||''
        ];
        return filters.every((f, idx) => !f || row[idx].toLowerCase().includes(f));
      });
      // Sáº¯p xáº¿p láº¡i theo thá»i gian má»›i nháº¥t lÃªn Ä‘áº§u
      filtered.sort((a, b) => {
        const ia = a.info || {}, ib = b.info || {};
        const getDate = i => `${i.thoi_gian_tu_nam||''}${i.thoi_gian_tu_thang||''}${i.thoi_gian_tu_ngay||''}`;
        return getDate(ib).localeCompare(getDate(ia));
      });
      let html = '';
      filtered.forEach(item => {
        const i = item.info || {};
        html += `<tr>
          <td>${i.ho_ten||''}</td>
          <td>${i.cap_bac||''}</td>
          <td>${i.chuc_vu||''}</td>
          <td>${i.don_vi||''}</td>
          <td>${i.loai_doi_tuong||''}</td>
          <td>${i.so_ho_so||''}</td>
          <td>${i.thoi_gian_tu_ngay||''}/${i.thoi_gian_tu_thang||''}/${i.thoi_gian_tu_nam||''} - ${i.thoi_gian_den_ngay||''}/${i.thoi_gian_den_thang||''}/${i.thoi_gian_den_nam||''}</td>
          <td>${i.can_bo_dia_danh||''}</td>
          <td>${i.lanh_dao_dia_danh||''}</td>
          <td>${item.tong_diem_cb||''}</td>
          <td>${item.tong_diem_ch||''}</td>
          <td>${item.xep_loai_cb||''}</td>
          <td>${item.xep_loai_ch||''}</td>
          <td><button class="action-btn action-view" onclick="viewForm('${currentFormType === 'phieu-cham-diem-hn' ? 'forms/phieu-cham-diem-hn.html' : 'forms/phieu-cham-diem-dtcb.html'}','${item.form_id}')">Xem/Chá»‰nh sá»­a</button></td>
        </tr>`;
      });
      document.getElementById('formHistoryTableBody').innerHTML = html;
    }

    // ThÃªm hÃ m xÃ³a form
    function deleteForm(formId, btn) {
      if (!confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a form nÃ y?')) return;
      btn.disabled = true;
      console.log('Gá»­i yÃªu cáº§u xÃ³a form_id:', formId);
      fetch(`/api/forms/dtcb/${encodeURIComponent(formId)}`, { method: 'DELETE' })
        .then(async res => {
          let data;
          try { data = await res.json(); } catch (e) { data = {}; }
          if (res.ok && data.success) {
            // XÃ³a dÃ²ng khá»i báº£ng
            const tr = btn.closest('tr');
            if (tr) tr.remove();
            alert('ÄÃ£ xÃ³a thÃ nh cÃ´ng!');
          } else if (res.status === 404) {
            alert('KhÃ´ng tÃ¬m tháº¥y form trong database (404). CÃ³ thá»ƒ form nÃ y Ä‘Ã£ bá»‹ xÃ³a hoáº·c khÃ´ng tá»“n táº¡i.');
            console.warn('XÃ³a tháº¥t báº¡i: KhÃ´ng tÃ¬m tháº¥y form_id:', formId, data);
            btn.disabled = false;
          } else {
            alert('XÃ³a tháº¥t báº¡i!\n' + (data.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh.'));
            console.error('XÃ³a tháº¥t báº¡i:', formId, data);
            btn.disabled = false;
          }
        })
        .catch((err) => {
          alert('Lá»—i khi xÃ³a!');
          console.error('Lá»—i khi gá»­i yÃªu cáº§u xÃ³a:', err);
          btn.disabled = false;
        });
    }

    // Check authentication when page loads
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>
